rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    function pageData(slug) {
      return get(/databases/$(database)/documents/pages/$(slug)).data;
    }

    function isOwner(slug) {
      return isSignedIn() && (uid() in pageData(slug).owner_uids);
    }

    function canReadPage(slug) {
      return pageData(slug).visibility == "public" || isOwner(slug);
    }

    // --- Users ---
    match /users/{userId} {
      allow read: if isSignedIn() && uid() == userId;
      allow create: if isSignedIn() && uid() == userId;
      allow update: if isSignedIn() && uid() == userId;
      allow delete: if false;
    }

    // --- Pages ---
    match /pages/{slug} {
      allow read: if resource.data.visibility == "public"
                  || (isSignedIn() && uid() in resource.data.owner_uids);
      allow create: if isSignedIn()
                    && request.resource.data.owner_uids.size() >= 1
                    && uid() in request.resource.data.owner_uids;
      allow update: if isSignedIn() && uid() in resource.data.owner_uids
                    && request.resource.data.owner_uids.size() >= 1;
      allow delete: if isSignedIn() && uid() in resource.data.owner_uids;

      // --- Invites (subcollection of pages) ---
      match /invites/{inviteId} {
        // Owners can read invites for their page
        allow read: if isOwner(slug);
        // Only server (Admin SDK) creates/updates invites
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }
    }

    // --- Memories ---
    match /memories/{memoryId} {
      allow read: if resource.data.page_id != null
                  && canReadPage(resource.data.page_id);
      // Legacy: allow read if user_id matches (for backward compat)
      allow read: if isSignedIn() && resource.data.user_id == uid();
      allow create: if isSignedIn()
                    && request.resource.data.page_id != null
                    && isOwner(request.resource.data.page_id);
      allow update: if isSignedIn()
                    && resource.data.page_id != null
                    && isOwner(resource.data.page_id);
      allow delete: if isSignedIn()
                    && resource.data.page_id != null
                    && isOwner(resource.data.page_id);
    }

    // --- Audit log (server-only, append-only) ---
    match /audit_log/{entryId} {
      allow read: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}
